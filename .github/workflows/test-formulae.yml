name: Test Formulae

on:
  push:
    branches: [main]
    paths:
      - "Formula/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
    paths:
      - "Formula/**"
      - ".github/workflows/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    # Linuxbrew works for all formulae in this tap (none are macOS-only).
    # macOS runners cost 10x -- only enable if a formula adds depends_on :macos.
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap local checkout
        env:
          HOMEBREW_NO_INSTALL_FROM_API: 1
        run: |
          # Create the tap directory Homebrew expects, then symlink our checkout into it.
          tap_dir="$(brew --repository)/Library/Taps/mcp-tool-shop-org/homebrew-mcp-tools"
          mkdir -p "$(dirname "$tap_dir")"
          ln -sfn "${{ github.workspace }}" "$tap_dir"

      - name: List formulae
        run: |
          echo "Formulae in this tap:"
          ls -1 Formula/*.rb

      - name: Audit formulae
        run: |
          echo "Running brew audit..."
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            echo "Auditing mcp-tool-shop-org/mcp-tools/$formula_name..."
            brew audit --strict "mcp-tool-shop-org/mcp-tools/$formula_name" || echo "Audit warnings for $formula_name"
          done

      - name: Style check
        run: |
          echo "Running brew style check..."
          brew style Formula/*.rb || echo "Style warnings found"

      - name: Test formula syntax
        run: |
          echo "Testing formula syntax..."
          for formula in Formula/*.rb; do
            formula_name=$(basename "$formula" .rb)
            echo "Testing mcp-tool-shop-org/mcp-tools/$formula_name..."
            brew info "mcp-tool-shop-org/mcp-tools/$formula_name" || echo "Info failed for $formula_name"
          done
